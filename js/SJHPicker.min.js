/*!
* Product: SJHPicker
* Version: 0.2.0
* Last Updated: 2016年8月12日 17:40:52
*
* Copyright (c) 2016 TurboExtension
* Licensed under the MIT license
*/
;Date.prototype.Format=function(a){var c={"M+":this.getMonth()+1,"d+":this.getDate(),"h+":this.getHours(),"m+":this.getMinutes(),"s+":this.getSeconds(),"q+":Math.floor((this.getMonth()+3)/3),S:this.getMilliseconds()};if(/(y+)/.test(a)){a=a.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length))}for(var b in c){if(new RegExp("("+b+")").test(a)){a=a.replace(RegExp.$1,(RegExp.$1.length==1)?(c[b]):(("00"+c[b]).substr((""+c[b]).length)))}}return a};function _getUniDate(b){var a=new Date(b);return new Date(a.getFullYear(),a.getMonth(),a.getDate())}var SJHPicker={start_day:1,selected_date:NaN,min_date:NaN,max_date:NaN,format:null,init:function(c){if(c!=undefined){if(c.max_date!=null){if(isNaN(c.max_date.getDay())){console.error("max_date is invalid")}SJHPicker.max_date=_getUniDate(c.max_date)}if(c.min_date!=null){if(isNaN(c.min_date.getDay())){console.error("min_date is invalid")}SJHPicker.min_date=_getUniDate(c.min_date)}if(c.min_date>c.max_date){SJHPicker.min_date=NaN;SJHPicker.max_date=NaN;throw new Error("下限日期不能晚于上限日期")}if(c.selected_date!=null){if(isNaN(c.selected_date.getDay())){console.error("selected_date is invalid")}SJHPicker.selected_date=_getUniDate(c.selected_date)}if(c.start_day!=null){if(c.start_day<0||c.start_day>6){console.error("start_day必须在区间[0, 6]内！")}SJHPicker.start_day=c.start_day}if(c.format!=null){if(isNaN(new Date(new Date().Format(c.format)).getDay())){console.warn('格式"'+c.format+'"可能会引发错误')}SJHPicker.format=c.format}}var a=document.getElementsByTagName("input");for(var b=0;b<a.length;++b){if(a[b].getAttribute("data-field")=="date"){a[b].onclick=function(){SJHPicker.show(this)}}}},show:function(a){var b;if(a.value.length>0){b=_getUniDate(a.value)}else{b=_getUniDate(new Date())}if(SJHPicker.min_date!=null){if(b<SJHPicker.min_date){b=SJHPicker.min_date}}if(SJHPicker.min_date!=null){if(a>SJHPicker.max_date){b=SJHPicker.max_date}}SJHPicker.selected_date=b;SJHPicker.generate_panel(b);document.getElementById("SJHPicker").style.display="flex";document.getElementById("sjhpicker_btn_confirm").onclick=function(){SJHPicker.confirm(a)}},cancel:function(){document.getElementById("SJHPicker").style.display="none"},confirm:function(a){if(SJHPicker.format!=null){a.value=SJHPicker.selected_date.Format(SJHPicker.format)}else{a.value=SJHPicker.selected_date.Format("yyyy-MM-dd")}document.getElementById("SJHPicker").style.display="none"},generate_panel:function(e){var h=document.getElementById("SJHPicker");if(h==null){return}var j='<div id="sjhpicker_panel" onselectstart="return false;" unselectable="on">';j+='<div id="sjhpicker_title">选择日期</div>';var c='<div id="sjhpicker_btn_preyear"></div>';var b='<div id="sjhpicker_btn_premonth"></div>';var a='<div id="sjhpicker_btn_nextmonth"></div>';var d='<div id="sjhpicker_btn_nextyear"></div>';j+='<div id="sjhpicker_myselector">'+c+b;j+='<div id="sjhpicker_myvalue">'+e.getFullYear()+" 年 "+(e.getMonth()+1)+" 月</div>";j+=a+d+"</div>";j+='<div id="sjhpicker_days">';days=["日","一","二","三","四","五","六"];var g=this.start_day;for(var f=0;f<=6;++f){j+='<div class="sjhpicker_day">'+days[g%7]+"</div>";++g}j+="</div>";j+='<div id="sjhpicker_dselector"></div>';j+='<div id="sjhpicker_btnrow"><div id="sjhpicker_btn_today">今日</div><div id="sjhpicker_btn_confirm">确认</div><div id="sjhpicker_btn_cancel">取消</div></div>';j+="</div>";h.innerHTML=j;this.generate_date_of_month(e);document.getElementById("sjhpicker_btn_premonth").onclick=this.pre_month;document.getElementById("sjhpicker_btn_preyear").onclick=this.pre_year;document.getElementById("sjhpicker_btn_nextmonth").onclick=this.next_month;document.getElementById("sjhpicker_btn_nextyear").onclick=this.next_year;if(_getUniDate(new Date())<SJHPicker.min_date||_getUniDate(new Date())<SJHPicker.max_date){var k=document.getElementById("sjhpicker_btn_today");k.parentNode.removeChild(k)}else{document.getElementById("sjhpicker_btn_today").onclick=this.select_today}document.getElementById("sjhpicker_btn_cancel").onclick=this.cancel},generate_date_of_month:function(d){var m=_getUniDate(d.Format("yyyy-MM-01"));var c;if(m.getMonth()<=11){c=new Date(d.getFullYear(),d.getMonth()+1,1)}else{c=_getUniDate(d.Format("yyyy-01-01"))}c.setDate(c.getDate()-1);var b="";if(isNaN(m.getDay())){throw new Error("adate isNaN");return}while(m.getDay()!=this.start_day){m.setDate(m.getDate()-1)}var h=_getUniDate(d.Format("yyyy-MM-01"));if(!isNaN(this.min_date)){if(this.min_date.getFullYear()==d.getFullYear()&&this.min_date.getMonth()==d.getMonth()){h=this.min_date}}var a=_getUniDate(c);if(!isNaN(this.max_date)){if(this.max_date.getFullYear()==d.getFullYear()&&this.max_date.getMonth()==d.getMonth()){a=this.max_date}}do{if(m.getDay()==this.start_day){b+="<div class=sjhpicker_dayrow>"}if(m<h||m>a){b+=('<div class="sjhpicker_date_disabled" id="sjhpicker_date_'+m.Format("yyyy-MM-dd")+'">'+m.getDate().toString()+"</div>")}else{b+=('<div class="sjhpicker_date" id="sjhpicker_date_'+m.Format("yyyy-MM-dd")+'">'+m.getDate().toString()+"</div>")}if(m.getDay()==(this.start_day+6)%7){b+="</div>"}m.setDate(m.getDate()+1)}while(m<=c);m.setDate(m.getDate()-1);while(m.getDay()!=(this.start_day+6)%7){m.setDate(m.getDate()+1);b+=('<div class="sjhpicker_date_disabled" id="sjhpicker_date_'+m.Format("yyyy-MM-dd")+'">'+m.getDate().toString()+"</div>");if(m.getDay()==(this.start_day+6)%7){b+="</div>"}}document.getElementById("sjhpicker_dselector").innerHTML=b;var k=_getUniDate(new Date());if(k>=h&&k<=a){var f=document.getElementById("sjhpicker_date_"+k.Format("yyyy-MM-dd"));if(f!=null){f.style.backgroundColor="#ddd"}}var g=document.getElementsByClassName("sjhpicker_date");for(var e=0;e<g.length;++e){g[e].onclick=function(){SJHPicker.selected_date=_getUniDate(this.id.substr(15));for(var n=0;n<g.length;++n){if(g[n]!=f){g[n].style.backgroundColor="rgba(0, 0, 0, 0)"}else{g[n].style.backgroundColor="#ddd"}}this.style.backgroundColor="#F2BE45"}}var j=d.getFullYear()+" 年 "+(d.getMonth()+1)+" 月";document.getElementById("sjhpicker_myvalue").textContent=j;var l=document.getElementById("sjhpicker_date_"+this.selected_date.Format("yyyy-MM-dd"));if(l!=null){l.style.backgroundColor="#F2BE45"}if(!isNaN(this.min_date)){if(d.getMonth()==this.min_date.getMonth()&&d.getFullYear()==this.min_date.getFullYear()){document.getElementById("sjhpicker_btn_premonth").style.visibility="hidden";document.getElementById("sjhpicker_btn_preyear").style.visibility="hidden"}else{if(d.getFullYear()==this.min_date.getFullYear()){document.getElementById("sjhpicker_btn_premonth").style.visibility="inherit";document.getElementById("sjhpicker_btn_preyear").style.visibility="hidden"}else{document.getElementById("sjhpicker_btn_premonth").style.visibility="inherit";document.getElementById("sjhpicker_btn_preyear").style.visibility="inherit"}}}if(!isNaN(this.max_date)){if(d.getMonth()==this.max_date.getMonth()&&d.getFullYear()==this.max_date.getFullYear()){document.getElementById("sjhpicker_btn_nextmonth").style.visibility="hidden";document.getElementById("sjhpicker_btn_nextyear").style.visibility="hidden"}else{if(d.getFullYear()==this.max_date.getFullYear()){document.getElementById("sjhpicker_btn_nextmonth").style.visibility="inherit";document.getElementById("sjhpicker_btn_nextyear").style.visibility="hidden"}else{document.getElementById("sjhpicker_btn_nextmonth").style.visibility="inherit";document.getElementById("sjhpicker_btn_nextyear").style.visibility="inherit"}}}},getCurrentMonth:function(){var a=document.getElementById("sjhpicker_myvalue").textContent;return new Date(parseInt(a.substr(0,4)),parseInt(a.substr(7,2))-1,1)},next_month:function(){var a=SJHPicker.getCurrentMonth();a.setMonth(a.getMonth()+1);SJHPicker.generate_date_of_month(a)},next_year:function(){var a=SJHPicker.getCurrentMonth();a.setFullYear(a.getFullYear()+1);if(a.getMonth()>SJHPicker.max_date.getMonth()){console.log(a.getMonth()>SJHPicker.max_date.getMonth());a.setMonth(SJHPicker.max_date.getMonth())}SJHPicker.generate_date_of_month(a)},pre_month:function(){var a=SJHPicker.getCurrentMonth();a.setMonth(a.getMonth()-1);SJHPicker.generate_date_of_month(a)},pre_year:function(){var a=SJHPicker.getCurrentMonth();a.setFullYear(a.getFullYear()-1);if(a.getMonth()<SJHPicker.min_date.getMonth()){a.setMonth(SJHPicker.min_date.getMonth())}SJHPicker.generate_date_of_month(a)},select_today:function(){SJHPicker.setSelectedDate(_getUniDate(new Date()))},setSelectedDate:function(a){SJHPicker.selected_date=a;SJHPicker.generate_date_of_month(a)}};