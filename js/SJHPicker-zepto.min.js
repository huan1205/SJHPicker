/*!
* Product: SJHPicker
* Version: 0.2.0
* Last Updated: 2016年8月12日 17:40:52
*
* Copyright (c) 2016 TurboExtension
* Licensed under the MIT license
*/
;Date.prototype.Format=function(a){var c={"M+":this.getMonth()+1,"d+":this.getDate(),"h+":this.getHours(),"m+":this.getMinutes(),"s+":this.getSeconds(),"q+":Math.floor((this.getMonth()+3)/3),S:this.getMilliseconds()};if(/(y+)/.test(a)){a=a.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length))}for(var b in c){if(new RegExp("("+b+")").test(a)){a=a.replace(RegExp.$1,(RegExp.$1.length==1)?(c[b]):(("00"+c[b]).substr((""+c[b]).length)))}}return a};function _getUniDate(b){var a=new Date(b);return new Date(a.getFullYear(),a.getMonth(),a.getDate())}var SJHPicker={start_day:1,selected_date:NaN,min_date:NaN,max_date:NaN,format:null,init:function(a){if(a!=undefined){if(a.max_date!=null){if(isNaN(a.max_date.getDay())){console.error("max_date is invalid")}SJHPicker.max_date=_getUniDate(a.max_date)}if(a.min_date!=null){if(isNaN(a.min_date.getDay())){console.error("min_date is invalid")}SJHPicker.min_date=_getUniDate(a.min_date)}if(a.min_date>a.max_date){SJHPicker.min_date=NaN;SJHPicker.max_date=NaN;throw new Error("下限日期不能晚于上限日期")}if(a.selected_date!=null){if(isNaN(a.selected_date.getDay())){console.error("selected_date is invalid")}SJHPicker.selected_date=_getUniDate(a.selected_date)}if(a.start_day!=null){if(a.start_day<0||a.start_day>6){console.error("start_day必须在区间[0, 6]内！")}SJHPicker.start_day=a.start_day}if(a.format!=null){if(isNaN(new Date(new Date().Format(a.format)).getDay())){console.warn('格式"'+a.format+'"可能会引发错误')}SJHPicker.format=a.format}}$("input[data-field=date]").tap(function(){SJHPicker.show(this)})},show:function(a){var b;if(a.value.length>0){b=_getUniDate(a.value)}else{b=_getUniDate(new Date())}if(SJHPicker.min_date!=null){if(b<SJHPicker.min_date){b=SJHPicker.min_date}}if(SJHPicker.min_date!=null){if(a>SJHPicker.max_date){b=SJHPicker.max_date}}SJHPicker.selected_date=b;SJHPicker.generate_panel(b);$("#SJHPicker").css("display","flex");$("#sjhpicker_btn_confirm").tap(function(){SJHPicker.confirm(a)})},cancel:function(){$("#SJHPicker").hide()},confirm:function(a){if(SJHPicker.format!=null){a.value=SJHPicker.selected_date.Format(SJHPicker.format)}else{a.value=SJHPicker.selected_date.Format("yyyy-MM-dd")}$("#SJHPicker").hide()},generate_panel:function(e){var h=$("#SJHPicker");if(h==null){return}var j='<div id="sjhpicker_panel" onselectstart="return false;" unselectable="on">';j+='<div id="sjhpicker_title">选择日期</div>';var c='<div id="sjhpicker_btn_preyear"></div>';var b='<div id="sjhpicker_btn_premonth"></div>';var a='<div id="sjhpicker_btn_nextmonth"></div>';var d='<div id="sjhpicker_btn_nextyear"></div>';j+='<div id="sjhpicker_myselector">'+c+b;j+='<div id="sjhpicker_myvalue">'+e.getFullYear()+" 年 "+(e.getMonth()+1)+" 月</div>";j+=a+d+"</div>";j+='<div id="sjhpicker_days">';days=["日","一","二","三","四","五","六"];var g=this.start_day;for(var f=0;f<=6;++f){j+='<div class="sjhpicker_day">'+days[g%7]+"</div>";++g}j+="</div>";j+='<div id="sjhpicker_dselector"></div>';j+='<div id="sjhpicker_btnrow"><div id="sjhpicker_btn_today">今日</div><div id="sjhpicker_btn_confirm">确认</div><div id="sjhpicker_btn_cancel">取消</div></div>';j+="</div>";h.html(j);this.generate_date_of_month(e);$("#sjhpicker_btn_premonth").tap(this.pre_month);$("#sjhpicker_btn_preyear").tap(this.pre_year);$("#sjhpicker_btn_nextmonth").tap(this.next_month);$("#sjhpicker_btn_nextyear").tap(this.next_year);if(_getUniDate(new Date())<SJHPicker.min_date||_getUniDate(new Date())<SJHPicker.max_date){var k=$("#sjhpicker_btn_today").remove()}else{$("#sjhpicker_btn_today").tap(this.select_today)}$("#sjhpicker_btn_cancel").tap(this.cancel)},generate_date_of_month:function(g){var e=_getUniDate(g.Format("yyyy-MM-01"));var d;if(e.getMonth()<=11){d=new Date(g.getFullYear(),g.getMonth()+1,1)}else{d=_getUniDate(g.Format("yyyy-01-01"))}d.setDate(d.getDate()-1);var a="";if(isNaN(e.getDay())){throw new Error("adate isNaN");return}while(e.getDay()!=this.start_day){e.setDate(e.getDate()-1)}var b=_getUniDate(g.Format("yyyy-MM-01"));if(!isNaN(this.min_date)){if(this.min_date.getFullYear()==g.getFullYear()&&this.min_date.getMonth()==g.getMonth()){b=this.min_date}}var h=_getUniDate(d);if(!isNaN(this.max_date)){if(this.max_date.getFullYear()==g.getFullYear()&&this.max_date.getMonth()==g.getMonth()){h=this.max_date}}do{if(e.getDay()==this.start_day){a+="<div class=sjhpicker_dayrow>"}if(e<b||e>h){a+=('<div class="sjhpicker_date_disabled" id="sjhpicker_date_'+e.Format("yyyy-MM-dd")+'">'+e.getDate().toString()+"</div>")}else{a+=('<div class="sjhpicker_date" id="sjhpicker_date_'+e.Format("yyyy-MM-dd")+'">'+e.getDate().toString()+"</div>")}if(e.getDay()==(this.start_day+6)%7){a+="</div>"}e.setDate(e.getDate()+1)}while(e<=d);e.setDate(e.getDate()-1);while(e.getDay()!=(this.start_day+6)%7){e.setDate(e.getDate()+1);a+=('<div class="sjhpicker_date_disabled" id="sjhpicker_date_'+e.Format("yyyy-MM-dd")+'">'+e.getDate().toString()+"</div>");if(e.getDay()==(this.start_day+6)%7){a+="</div>"}}$("#sjhpicker_dselector").html(a);var c=_getUniDate(new Date());if(c>=b&&c<=h){$("#sjhpicker_date_"+c.Format("yyyy-MM-d")).css("background-color","#ddd")}$(".sjhpicker_date").tap(function(){SJHPicker.selected_date=_getUniDate(this.id.substr(15));btn_dates_notToday=$(".sjhpicker_date:not(#sjhpicker_date_"+c.Format("yyyy-MM-d")+")");btn_dates_notToday.css("background-color","rgba(0, 0, 0, 0)");$("#sjhpicker_date_"+c.Format("yyyy-MM-dd")).css("background-color","#ddd");$(this).css("background-color","#F2BE45")});var f=g.getFullYear()+" 年 "+(g.getMonth()+1)+" 月";$("#sjhpicker_myvalue").text(f);$("#sjhpicker_date_"+this.selected_date.Format("yyyy-MM-dd")).css("background-color","#F2BE45");if(!isNaN(this.min_date)){if(g.getMonth()==this.min_date.getMonth()&&g.getFullYear()==this.min_date.getFullYear()){$("#sjhpicker_btn_premonth").css("visibility","hidden");$("#sjhpicker_btn_preyear").css("visibility","hidden")}else{if(g.getFullYear()==this.min_date.getFullYear()){$("#sjhpicker_btn_premonth").css("visibility","inherit");$("#sjhpicker_btn_preyear").css("visibility","hidden")}else{$("#sjhpicker_btn_premonth").css("visibility","inherit");$("#sjhpicker_btn_preyear").css("visibility","inherit")}}}if(!isNaN(this.max_date)){if(g.getMonth()==this.max_date.getMonth()&&g.getFullYear()==this.max_date.getFullYear()){$("#sjhpicker_btn_nextmonth").css("visibility","hidden");$("#sjhpicker_btn_nextyear").css("visibility","hidden")}else{if(g.getFullYear()==this.max_date.getFullYear()){$("#sjhpicker_btn_nextmonth").css("visibility","inherit");$("#sjhpicker_btn_nextyear").css("visibility","hidden")}else{$("#sjhpicker_btn_nextmonth").css("visibility","inherit");$("#sjhpicker_btn_nextyear").css("visibility","inherit")}}}},getCurrentMonth:function(){var a=$("#sjhpicker_myvalue").text();return new Date(parseInt(a.substr(0,4)),parseInt(a.substr(7,2))-1,1)},next_month:function(){var a=SJHPicker.getCurrentMonth();a.setMonth(a.getMonth()+1);SJHPicker.generate_date_of_month(a)},next_year:function(){var a=SJHPicker.getCurrentMonth();a.setFullYear(a.getFullYear()+1);if(a.getMonth()>SJHPicker.max_date.getMonth()){console.log(a.getMonth()>SJHPicker.max_date.getMonth());a.setMonth(SJHPicker.max_date.getMonth())}SJHPicker.generate_date_of_month(a)},pre_month:function(){var a=SJHPicker.getCurrentMonth();a.setMonth(a.getMonth()-1);SJHPicker.generate_date_of_month(a)},pre_year:function(){var a=SJHPicker.getCurrentMonth();a.setFullYear(a.getFullYear()-1);if(a.getMonth()<SJHPicker.min_date.getMonth()){a.setMonth(SJHPicker.min_date.getMonth())}SJHPicker.generate_date_of_month(a)},select_today:function(){SJHPicker.setSelectedDate(_getUniDate(new Date()))},setSelectedDate:function(a){SJHPicker.selected_date=a;SJHPicker.generate_date_of_month(a)}};